<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Password</title>
    <style>
        body { font-family: 'Segoe UI', Arial; background: #f5f5f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { width: 350px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .step { display: none; }
        .step.active { display: block; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        .input-group { display: flex; margin-top: 5px; }
        select { width: 30%; margin-right: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; margin-top: 20px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        .error { color: red; font-size: 12px; margin-top: 5px; display: none; }
        .link-btn { text-align: center; margin-top: 15px; font-size: 13px; color: #007bff; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>Reset Password</h2>

    <div id="step1" class="step active">
        <label>Mobile Number</label>
        <div class="input-group">
            <select id="code"><option value="+91">+91</option></select>
            <input id="mobile" type="text" placeholder="10-digit number">
        </div>
        <div class="error" id="mobileErr"></div>
        <button onclick="sendOtp()">Get OTP</button>
    </div>

    <div id="step2" class="step">
        <label>Enter OTP</label>
        <input id="otp" type="text" maxlength="6" placeholder="6-digit code">
        <div class="error" id="otpErr"></div>
        <button onclick="verifyOtp()">Verify & Continue</button>
        <div class="link-btn" onclick="showStep(1)">Change Number</div>
    </div>

    <div id="step3" class="step">
        <label>New Password</label>
        <input id="newPass" type="password" placeholder="Min 6 characters">
        <label>Confirm Password</label>
        <input id="confPass" type="password">
        <div class="error" id="passErr"></div>
        <button onclick="updatePassword()">Update Database</button>
    </div>
</div>

<script>
let userMobile = "";

function showStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
}

function sendOtp() {
    const num = document.getElementById("mobile").value;
    userMobile = document.getElementById("code").value + num;
    fetch("/api/forgot-password/send-otp", {
        method: "POST", 
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ mobile: userMobile })
    })
    .then(r => r.json()).then(d => {
        if(d.success) showStep(2); else alert(d.message);
    });
}


function verifyOtp() {
    const otp = document.getElementById("otp").value;
    fetch("/api/forgot-password/verify-otp", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ mobile: userMobile, otp: otp })
    })
    .then(r => r.json()).then(d => {
        if(d.success) {
            alert("OTP Verified Successfully!");
            showStep(3); // Proceed to Password Reset
        } else {
            alert("Invalid OTP! Please try again or request a new one.");
            document.getElementById("otp").value = ""; // Clear field for retry
        }
    });
}

function updatePassword() {
    const p1 = document.getElementById("newPass").value;
    const p2 = document.getElementById("confPass").value;
    
    if(p1.length < 8) { alert("Password must be at least 8 characters"); return; }
    if(p1 !== p2) { alert("Passwords do not match"); return; }
    
    fetch("/api/forgot-password/update", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ mobile: userMobile, newPassword: p1 })
    })
    .then(r => r.json()).then(d => {
        if(d.success) {
            alert("Password updated in Database! Please login with your new password.");
            window.location.href = "signin.html";
        }
    });
}
</script>
</body>
</html>
