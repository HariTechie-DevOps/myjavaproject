package com.spark.chat.controller;

import org.springframework.web.bind.annotation.*;
import org.springframework.beans.factory.annotation.Autowired;
import com.example.signup.repository.UserRepository;
import com.example.signup.entity.User;
import java.util.Map;

// These two classes fix the "cannot find symbol" errors
class SigninRequest {
    public String mobile;
    public String password;
}

class ForgotPasswordRequest {
    public String name;
    public String mobile;
    public String newPassword;
}

@RestController
@RequestMapping("/api")
@CrossOrigin
public class AuthController {

    @Autowired 
    private UserRepository repo;

    @PostMapping("/signin")
    public Map<String, Object> signin(@RequestBody SigninRequest req) {
        User user = repo.findByMobile(req.mobile).orElse(null);
        if (user == null)
            return Map.of("success", false, "message", "Mobile not found");

        if (!user.getPassword().equals(req.password))
            return Map.of("success", false, "message", "Invalid password");

        return Map.of("success", true, "token", user.getToken());
    }

    @PostMapping("/forgotpassword")
    public Map<String, Object> forgot(@RequestBody ForgotPasswordRequest req) {
        User user = repo.findByName(req.name).orElse(null);
        if (user == null || !user.getMobile().equals(req.mobile))
            return Map.of("success", false, "message", "Invalid name or mobile");

        user.setPassword(req.newPassword);
        repo.save(user);

        return Map.of("success", true);
    }
}
